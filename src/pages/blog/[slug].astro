--- 
// ARCHIVO RECONSTRUIDO DESDE CERO - PASO 1
import BaseLayout from '../../layouts/BaseLayout.astro';
import blogData from '../../data/blog.json';

// L√≥gica para obtener los datos del post
export async function getStaticPaths() {
    return blogData.map(post => ({
        params: { slug: post.slug },
        props: { post }
    }));
}

const { post } = Astro.props;

// Formatear fecha para la metadata
const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
};

// Obtener art√≠culos relacionados (misma categor√≠a o recientes)
const relatedPosts = blogData
    .filter(p => p.id !== post.id) // Excluir el post actual
    .filter(p => p.category === post.category || p.featured) // Misma categor√≠a o destacados
    .slice(0, 6); // M√°ximo 6 posts

// Si no hay suficientes de la misma categor√≠a, rellenar con otros recientes
if (relatedPosts.length < 3) {
    const otherPosts = blogData
        .filter(p => p.id !== post.id && !relatedPosts.includes(p))
        .slice(0, 6 - relatedPosts.length);
    relatedPosts.push(...otherPosts);
}
---

<BaseLayout 
    title={`${post.title} | Blog Edici√≥n Aular`}
    description={post.excerpt}>

    <!-- Progress Bar de Lectura (Rosa, ARRIBA - Justo debajo del header) -->
    <div id="readingProgressBar" style="position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: linear-gradient(90deg, #ff4d91, #ff69b4, #ff1493); z-index: 99999; transition: width 0.15s ease; box-shadow: 0 2px 10px rgba(255, 77, 145, 0.5);"></div>

    <div class="stg-container">
        <!-- PASO 1: Encabezado del Art√≠culo -->
        <section style="padding-bottom: 1rem;">
            <div class="bringer-page-intro">
                <div class="stg-row">
                    <div class="stg-col-8 stg-offset-2">
                        <!-- Breadcrumb -->
                        <nav class="bringer-breadcrumb">
                            <ul>
                                <li><a href="/">Home</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><span>{post.category}</span></li>
                            </ul>
                        </nav>

                        <!-- T√≠tulo -->
                        <h1 class="bringer-page-title">
                            {post.title}
                        </h1>

                        <!-- Meta Info -->
                        <div class="bringer-post-meta">
                            <div class="bringer-post-author">
                                <span class="bringer-meta">Por <strong>{post.author}</strong></span>
                            </div>
                            <span class="bringer-meta">‚Ä¢</span>
                            <span class="bringer-meta">{formatDate(post.date)}</span>
                            <span class="bringer-meta">‚Ä¢</span>
                            <span class="bringer-meta">{post.readTime} de lectura</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- IMAGEN DEL BLOG CON ANIMACI√ìN -->
        <section class="is-fullwidth" style="padding: 2rem 0 3rem 0;">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <div class="st-expandable-wrap">
                        <div class="bringer-expand-on-scroll">
                            <img src={post.image} alt={post.title} width="1200" height="630" data-unload="fade-up" />
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CONTENIDO DEL ART√çCULO -->
        <section style="padding-top: 0;">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <article class="bringer-post-content">
                        <!-- Resumen -->
                        <div class="bringer-post-excerpt">
                            <p class="bringer-large-text">{post.excerpt}</p>
                        </div>

                        <!-- Contenido Principal -->
                        <div class="bringer-post-body">
                            {/* Contenido HTML directo desde el JSON */}
                            <div set:html={post.content} />

                            <div class="stg-top-gap-l">
                                <blockquote class="bringer-blockquote">
                                    <p>"La diferencia entre el √©xito y el fracaso est√° en implementar lo que aprendes, no solo en saberlo."</p>
                                    <cite>‚Äî Edison Aular, Fundador de Edici√≥n Aular</cite>
                                </blockquote>
                            </div>

                            <h2>¬øPor Qu√© Funciona y C√≥mo Aplicarlo?</h2>
                            <p>Esta estrategia ha sido probada por miles de negocios exitosos. La clave est√° en adaptar lo que ya funciona a tu contexto espec√≠fico, sin reinventar la rueda.</p>

                            <p><strong>Tu siguiente paso:</strong> Puedes intentarlo solo o trabajar con expertos que aceleren tus resultados. En Edici√≥n Aular te ayudamos a implementarlo paso a paso. <a href="https://cal.com/edicion-aular-website" style="color: var(--accent-color); text-decoration: underline;">Agenda una consultor√≠a gratuita ‚Üí</a></p>
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <!-- PASO 3: CTA (Call to Action) -->
        <section class="divider-top">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <div class="bringer-cta-box bringer-block align-center">
                        <h3>¬øTe Gust√≥ Este Art√≠culo?<span class="bringer-accent">.</span></h3>
                        <p class="bringer-large-text">
                            Agenda una consultor√≠a gratuita y descubre c√≥mo podemos ayudarte a implementar estas estrategias en tu negocio.
                        </p>
                        <div class="stg-top-gap">
                            <a href="https://cal.com/edicion-aular-website" class="bringer-button">Agendar Consultor√≠a</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Carousel de Art√≠culos Relacionados -->
        {relatedPosts.length > 0 && (
            <section class="backlight-bottom" style="margin-top: 6rem;">
                <div class="stg-row bringer-section-title">
                    <div class="stg-col-8 stg-offset-2">
                        <div class="align-center">
                            <h2 data-appear="fade-up" data-unload="fade-up">Art√≠culos Relacionados<span class="bringer-accent">.</span></h2>
                            <p class="bringer-large-text" data-appear="fade-up" data-unload="fade-up" data-delay="100">
                                Contin√∫a aprendiendo con estos art√≠culos
                            </p>
                        </div>
                    </div>
                </div>

                <div class="swiper bringer-carousel" data-appear="fade-up" data-delay="200" data-unload="fade-up">
                    <div class="swiper-wrapper">
                        {relatedPosts.map((relatedPost) => (
                            <div class="bringer-block bringer-blog-card swiper-slide">
                                <a href={`/blog/${relatedPost.slug}`} style="display: block; height: 100%; text-decoration: none; color: inherit;">
                                    <div class="bringer-blog-card-image">
                                        <img src={relatedPost.image} alt={relatedPost.title} width="800" height="450" loading="lazy" decoding="async" />
                                    </div>
                                    <div class="bringer-blog-card-footer">
                                        <div class="bringer-blog-card-caption">
                                            <span class="bringer-meta">{relatedPost.category}</span>
                                            <h5 class="bringer-blog-card-title">{relatedPost.title}</h5>
                                            <p class="bringer-blog-card-excerpt">{relatedPost.excerpt}</p>
                                            <div class="bringer-blog-card-meta">
                                                <span class="bringer-meta">{formatDate(relatedPost.date)}</span>
                                                <span class="bringer-meta">‚Ä¢</span>
                                                <span class="bringer-meta">{relatedPost.readTime}</span>
                                            </div>
                                        </div>
                                        <!-- SVG Arrow Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0; opacity: 0.7; color: var(--accent-color);">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                            <polyline points="12 5 19 12 12 19"></polyline>
                                        </svg>
                                    </div>
                                </a>
                            </div>
                        ))}
                    </div>

                    <!-- Pagination Dots -->
                    <div class="swiper-pagination bringer-dots"></div>
                </div>
            </section>
        )}
    </div>

</BaseLayout>

<script>
    // Efecto de expansi√≥n de imagen al hacer scroll
    document.addEventListener('DOMContentLoaded', () => {
        const expandableImages = document.querySelectorAll('.bringer-expand-on-scroll');
        
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.2
        };

        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-init');
                }
            });
        }, observerOptions);

        expandableImages.forEach(img => {
            imageObserver.observe(img);
        });
    });
</script>

<style>
    /* Estilos m√≠nimos para esta fase */
    .bringer-breadcrumb ul {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
        margin: 0 0 1.5rem 0;
        font-size: 0.875rem;
    }
    .bringer-breadcrumb li:not(:last-child)::after {
        content: '/';
        margin-left: 0.5rem;
    }
    .bringer-post-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--bringer-s-border);
    }
    .bringer-post-content {
        font-size: 1.0625rem;
        line-height: 1.9; /* Aumentado de 1.8 a 1.9 */
    }
    
    /* T√≠tulos con espaciado UX/UI optimizado - FORZAR CON !important */
    .bringer-post-body h2 {
        margin-top: 5rem !important;
        margin-bottom: 2rem !important;
        padding-top: 1.5rem !important;
        line-height: 1.3 !important;
    }
    
    .bringer-post-body h3 {
        margin-top: 4rem !important;
        margin-bottom: 1.75rem !important;
        padding-top: 1rem !important;
        line-height: 1.4 !important;
    }
    
    .bringer-post-body h4 {
        margin-top: 3.5rem !important;
        margin-bottom: 1.5rem !important;
        padding-top: 0.75rem !important;
        line-height: 1.4 !important;
    }
    
    /* Espacio extra cuando t√≠tulos vienen despu√©s de listas o p√°rrafos */
    /* Targeting section context through any wrapper divs */
    .bringer-post-body section ul + h2,
    .bringer-post-body section ol + h2,
    .bringer-post-body section p + h2,
    .bringer-post-body div section ul + h2,
    .bringer-post-body div section ol + h2,
    .bringer-post-body div section p + h2 {
        margin-top: 7rem !important;
        padding-top: 2rem !important;
    }
    
    .bringer-post-body section ul + h3,
    .bringer-post-body section ol + h3,
    .bringer-post-body section p + h3,
    .bringer-post-body div section ul + h3,
    .bringer-post-body div section ol + h3,
    .bringer-post-body div section p + h3 {
        margin-top: 6rem !important;
        padding-top: 1.5rem !important;
    }
    
    /* T√≠tulos despu√©s de items de lista individuales */
    .bringer-post-body section li:last-child + h2,
    .bringer-post-body section li:last-child + h3,
    .bringer-post-body div section li:last-child + h2,
    .bringer-post-body div section li:last-child + h3 {
        margin-top: 6.5rem !important;
        padding-top: 2rem !important;
    }
    
    /* H2 y H3 dentro de section (regla general adicional) */
    .bringer-post-body section h2,
    .bringer-post-body div section h2 {
        margin-top: 7rem !important;
        padding-top: 2rem !important;
    }
    
    .bringer-post-body section h3,
    .bringer-post-body div section h3 {
        margin-top: 6rem !important;
        padding-top: 1.5rem !important;
    }
    
    /* Excepci√≥n: primer h2 de la section */
    .bringer-post-body section > h2:first-child,
    .bringer-post-body div section > h2:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Efecto de expansi√≥n al scroll - UX/UI Premium */
    .st-expandable-wrap {
        overflow: hidden;
        clip-path: inset(0% round 18px);
        border-radius: 18px;
    }
    
    .bringer-expand-on-scroll {
        transform: scale(1.08);
        transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
    }
    
    .bringer-expand-on-scroll.is-init {
        transform: scale(1);
    }
    
    .st-expandable-wrap img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
        border-radius: 18px;
    }
    
    /* Fallback para navegadores sin clip-path */
    @supports not (clip-path: inset(0% round 18px)) {
        .st-expandable-wrap {
            border-radius: 18px;
            overflow: hidden;
        }
    }
    /* Excerpt con m√°s espacio */
    .bringer-post-excerpt {
        margin-bottom: 3.5rem; /* Aumentado de 2.5rem */
        padding: 2rem 1.75rem; /* Aumentado padding interno */
        background: rgba(var(--bringer-s-accent-rgb), 0.05);
        border-left: 4px solid var(--bringer-s-accent);
        border-radius: 8px;
    }
    
    .bringer-post-excerpt p {
        line-height: 1.9;
        margin: 0;
    }
    
    /* P√°rrafos con respiraci√≥n mejorada */
    .bringer-post-body p {
        margin-bottom: 2rem; /* Aumentado de 1.5rem */
        line-height: 2; /* Aumentado de 1.9 */
        letter-spacing: 0.01em; /* Mejor legibilidad */
    }
    
    /* Listas con espacio generoso */
    .bringer-post-body ul,
    .bringer-post-body ol {
        margin: 2.5rem 0; /* Aumentado de 1.5rem */
        padding-left: 2.5rem; /* Aumentado de 2rem */
    }
    
    .bringer-post-body ul li,
    .bringer-post-body ol li {
        margin-bottom: 1.25rem; /* Aumentado de 0.75rem */
        line-height: 1.9; /* Aumentado de 1.7 */
        padding-left: 0.5rem;
    }
    
    .bringer-post-body ul li:last-child,
    .bringer-post-body ol li:last-child {
        margin-bottom: 0;
    }
    
    /* Listas anidadas */
    .bringer-post-body ul ul,
    .bringer-post-body ol ol,
    .bringer-post-body ul ol,
    .bringer-post-body ol ul {
        margin-top: 1rem;
        margin-bottom: 0;
    }
    
    .bringer-post-body strong {
        color: var(--bringer-s-accent);
        font-weight: 600;
    }
    
    /* Blockquote con m√°s aire */
    .bringer-cta-card {
        margin: 3rem 0; /* M√°s espacio arriba y abajo */
        padding: 2rem 2.5rem; /* M√°s padding interno */
    }

    /* Progress Bar siempre visible */
    #readingProgressBar {
        pointer-events: none;
        will-change: width;
    }

    /* üéØ Igualar alturas de cards del carousel */
    .bringer-carousel .swiper-slide {
        height: auto;
        display: flex;
    }

    .bringer-carousel .bringer-blog-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .bringer-carousel .bringer-blog-card a {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .bringer-carousel .bringer-blog-card-footer {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        justify-content: space-between;
    }

    .bringer-carousel .bringer-blog-card-caption {
        flex-grow: 1;
    }

    /* üéØ Pagination dots - Visible y elegante */
    .swiper-pagination.bringer-dots {
        position: relative !important;
        display: flex !important;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        margin-top: 2rem !important;
        padding: 1rem 0;
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet {
        width: 12px !important;
        height: 12px !important;
        background: rgba(255, 255, 255, 0.4) !important;
        opacity: 1 !important;
        transition: all 0.3s ease;
        border-radius: 50%;
        cursor: pointer;
        margin: 0 !important;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet-active {
        background: var(--accent-color) !important;
        width: 14px !important;
        height: 14px !important;
        box-shadow: 0 0 15px rgba(255, 77, 145, 0.8);
        border-color: var(--accent-color);
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet:hover {
        background: rgba(255, 255, 255, 0.7) !important;
        transform: scale(1.15);
        border-color: rgba(255, 255, 255, 0.5);
    }

    /* SVG en cards del carousel */
    .bringer-blog-card-footer svg {
        transition: transform 0.3s ease;
    }

    .bringer-blog-card:hover .bringer-blog-card-footer svg {
        transform: translateX(5px);
    }
</style>

<script is:inline>
// Forzar espaciado de t√≠tulos h2/h3/h4 para evitar que est√©n pegados
(function() {
    function applySpacing() {
        const postBody = document.querySelector('.bringer-post-body');
        if (!postBody) return;
        
        const h2Elements = postBody.querySelectorAll('section h2');
        const h3Elements = postBody.querySelectorAll('section h3');
        const h4Elements = postBody.querySelectorAll('section h4');
        
        // Aplicar espaciado a h2 (excepto el primero)
        h2Elements.forEach((h2, index) => {
            if (index > 0) {
                h2.style.setProperty('margin-top', '7rem', 'important');
                h2.style.setProperty('padding-top', '2rem', 'important');
            }
        });
        
        // Aplicar espaciado a h3
        h3Elements.forEach((h3) => {
            h3.style.setProperty('margin-top', '6rem', 'important');
            h3.style.setProperty('padding-top', '1.5rem', 'important');
        });
        
        // Aplicar espaciado a h4
        h4Elements.forEach((h4) => {
            h4.style.setProperty('margin-top', '5rem', 'important');
            h4.style.setProperty('padding-top', '1rem', 'important');
        });
        
        // LIMPIAR <p></p> VAC√çOS EN LISTAS (causa saltos de l√≠nea innecesarios)
        postBody.querySelectorAll('ol, ul').forEach((list) => {
            list.querySelectorAll('p').forEach((p) => {
                // Si el <p> est√° vac√≠o o solo tiene espacios/saltos
                if (p.innerHTML.trim() === '' || p.textContent.trim() === '') {
                    p.remove();
                }
            });
        });
    }
    
    // Ejecutar al cargar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applySpacing);
    } else {
        applySpacing();
    }
    
    // Re-aplicar por seguridad
    setTimeout(applySpacing, 500);
})();

// Progress Bar de Lectura
(function() {
    const progressBar = document.getElementById('readingProgressBar');
    
    if (!progressBar) return;
    
    function updateProgressBar() {
        // Calcular el progreso de scroll
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        // Calcular porcentaje
        const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
        
        // Actualizar ancho del progress bar
        progressBar.style.width = Math.min(scrollPercent, 100) + '%';
    }
    
    // Actualizar en scroll
    window.addEventListener('scroll', updateProgressBar, { passive: true });
    
    // Actualizar al cargar
    updateProgressBar();
})();

// Inicializar Carousel de Art√≠culos Relacionados
(function() {
    // Esperar a que Swiper est√© disponible
    function initRelatedCarousel() {
        if (typeof Swiper === 'undefined') {
            setTimeout(initRelatedCarousel, 100);
            return;
        }

        const carousel = document.querySelector('.bringer-carousel');
        if (!carousel) return;

        new Swiper(carousel, {
            slidesPerView: 1,
            spaceBetween: 30,
            speed: 800,
            grabCursor: true,
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
                pauseOnMouseEnter: true
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                dynamicBullets: false,
                renderBullet: function (index, className) {
                    return '<span class="' + className + '"></span>';
                }
            },
            breakpoints: {
                // Mobile
                320: {
                    slidesPerView: 1,
                    spaceBetween: 20
                },
                // Tablet
                768: {
                    slidesPerView: 2,
                    spaceBetween: 30
                },
                // Desktop
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 30
                }
            }
        });
    }

    // Iniciar cuando DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRelatedCarousel);
    } else {
        initRelatedCarousel();
    }
})();
</script>
