--- 
// ARCHIVO RECONSTRUIDO DESDE CERO - PASO 1
import BaseLayout from '../../layouts/BaseLayout.astro';
import blogData from '../../data/blog.json';

// Lógica para obtener los datos del post
export async function getStaticPaths() {
    return blogData.map(post => ({
        params: { slug: post.slug },
        props: { post }
    }));
}

const { post } = Astro.props;

// Formatear fecha para la metadata
const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
};

// Obtener artículos relacionados (misma categoría o recientes)
const relatedPosts = blogData
    .filter(p => p.id !== post.id) // Excluir el post actual
    .filter(p => p.category === post.category || p.featured) // Misma categoría o destacados
    .slice(0, 6); // Máximo 6 posts

// Si no hay suficientes de la misma categoría, rellenar con otros recientes
if (relatedPosts.length < 3) {
    const otherPosts = blogData
        .filter(p => p.id !== post.id && !relatedPosts.includes(p))
        .slice(0, 6 - relatedPosts.length);
    relatedPosts.push(...otherPosts);
}
---

<BaseLayout 
    title={`${post.title} | Blog Edición Aular`}
    description={post.excerpt}>

    <!-- Reading Progress Bar -->
    <div id="reading-progress-bar" style="position: fixed !important; bottom: 0 !important; left: 0 !important; width: 0% !important; height: 4px !important; background: linear-gradient(90deg, #ff1493, #ff69b4) !important; z-index: 999999999 !important; pointer-events: none !important; box-shadow: 0 -2px 12px rgba(255, 77, 145, 0.8) !important;"></div>

    <div class="stg-container">
        <!-- PASO 1: Encabezado del Artículo -->
        <section style="padding-bottom: 1rem;">
            <div class="bringer-page-intro">
                <div class="stg-row">
                    <div class="stg-col-8 stg-offset-2">
                        <!-- Breadcrumb -->
                        <nav class="bringer-breadcrumb">
                            <ul>
                                <li><a href="/">Home</a></li>
                                <li><a href="/blog">Blog</a></li>
                                <li><span>{post.category}</span></li>
                            </ul>
                        </nav>

                        <!-- Título -->
                        <h1 class="bringer-page-title">
                            {post.title}
                        </h1>

                        <!-- Meta Info -->
                        <div class="bringer-post-meta">
                            <div class="bringer-post-author">
                                <span class="bringer-meta">Por <strong>{post.author}</strong></span>
                            </div>
                            <span class="bringer-meta">•</span>
                            <span class="bringer-meta">{formatDate(post.date)}</span>
                            <span class="bringer-meta">•</span>
                            <span class="bringer-meta">{post.readTime} de lectura</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- IMAGEN DEL BLOG CON ANIMACIÓN -->
        <section class="is-fullwidth" style="padding: 2rem 0 3rem 0;">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <div class="st-expandable-wrap">
                        <div class="bringer-expand-on-scroll">
                            <img src={post.image} alt={post.title} width="1200" height="630" data-unload="fade-up" />
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CONTENIDO DEL ARTÍCULO -->
        <section style="padding-top: 0;">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <article class="bringer-post-content">
                        <!-- Resumen -->
                        <div class="bringer-post-excerpt">
                            <p class="bringer-large-text">{post.excerpt}</p>
                        </div>

                        <!-- Contenido Principal -->
                        <div class="bringer-post-body">
                            {/* Contenido HTML directo desde el JSON */}
                            <div set:html={post.content} />

                            <div class="stg-top-gap-l">
                                <blockquote class="bringer-blockquote">
                                    <p>"La diferencia entre el éxito y el fracaso está en implementar lo que aprendes, no solo en saberlo."</p>
                                    <cite>— Edison Aular, Fundador de Edición Aular</cite>
                                </blockquote>
                            </div>

                            <h2>¿Por Qué Funciona y Cómo Aplicarlo?</h2>
                            <p>Esta estrategia ha sido probada por miles de negocios exitosos. La clave está en adaptar lo que ya funciona a tu contexto específico, sin reinventar la rueda.</p>

                            <p><strong>Tu siguiente paso:</strong> Puedes intentarlo solo o trabajar con expertos que aceleren tus resultados. En Edición Aular te ayudamos a implementarlo paso a paso. <a href="https://cal.com/edicion-aular-website" style="color: var(--accent-color); text-decoration: underline;">Agenda una consultoría gratuita →</a></p>
                        </div>
                    </article>
                </div>
            </div>
        </section>

        <!-- PASO 3: CTA (Call to Action) -->
        <section class="divider-top">
            <div class="stg-row">
                <div class="stg-col-8 stg-offset-2">
                    <div class="bringer-cta-box bringer-block align-center">
                        <h3>¿Te Gustó Este Artículo?<span class="bringer-accent">.</span></h3>
                        <p class="bringer-large-text">
                            Agenda una consultoría gratuita y descubre cómo podemos ayudarte a implementar estas estrategias en tu negocio.
                        </p>
                        <div class="stg-top-gap">
                            <a href="https://cal.com/edicion-aular-website" class="bringer-button">Agendar Consultoría</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Carousel de Artículos Relacionados -->
        {relatedPosts.length > 0 && (
            <section class="backlight-bottom" style="margin-top: 6rem;">
                <div class="stg-row bringer-section-title">
                    <div class="stg-col-8 stg-offset-2">
                        <div class="align-center">
                            <h2 data-appear="fade-up" data-unload="fade-up">Artículos Relacionados<span class="bringer-accent">.</span></h2>
                            <p class="bringer-large-text" data-appear="fade-up" data-unload="fade-up" data-delay="100">
                                Continúa aprendiendo con estos artículos
                            </p>
                        </div>
                    </div>
                </div>

                <div class="swiper bringer-carousel" data-appear="fade-up" data-delay="200" data-unload="fade-up">
                    <div class="swiper-wrapper">
                        {relatedPosts.map((relatedPost) => (
                            <div class="bringer-block bringer-blog-card swiper-slide">
                                <a href={`/blog/${relatedPost.slug}`} style="display: block; height: 100%; text-decoration: none; color: inherit;">
                                    <div class="bringer-blog-card-image">
                                        <img src={relatedPost.image} alt={relatedPost.title} width="800" height="450" loading="lazy" decoding="async" />
                                    </div>
                                    <div class="bringer-blog-card-footer">
                                        <div class="bringer-blog-card-caption">
                                            <span class="bringer-meta">{relatedPost.category}</span>
                                            <h5 class="bringer-blog-card-title">{relatedPost.title}</h5>
                                            <p class="bringer-blog-card-excerpt">{relatedPost.excerpt}</p>
                                            <div class="bringer-blog-card-meta">
                                                <span class="bringer-meta">{formatDate(relatedPost.date)}</span>
                                                <span class="bringer-meta">•</span>
                                                <span class="bringer-meta">{relatedPost.readTime}</span>
                                            </div>
                                        </div>
                                        <!-- SVG Arrow Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0; opacity: 0.7; color: var(--accent-color);">
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                            <polyline points="12 5 19 12 12 19"></polyline>
                                        </svg>
                                    </div>
                                </a>
                            </div>
                        ))}
                    </div>

                    <!-- Pagination Dots -->
                    <div class="swiper-pagination bringer-dots"></div>
                </div>
            </section>
        )}
    </div>

</BaseLayout>

<script>
    // 🖼️ Efecto de expansión de TODAS las imágenes al hacer scroll
    document.addEventListener('DOMContentLoaded', () => {
        // Seleccionar imagen hero Y todas las imágenes del contenido
        const heroImage = document.querySelector('.bringer-expand-on-scroll');
        const contentImages = document.querySelectorAll('.bringer-post-body img');
        
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.2
        };

        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-init');
                }
            });
        }, observerOptions);

        // Observar imagen hero
        if (heroImage) {
            imageObserver.observe(heroImage);
        }

        // Observar TODAS las imágenes del contenido
        contentImages.forEach(img => {
            imageObserver.observe(img);
        });

        console.log('✅ Animación aplicada a:', contentImages.length + 1, 'imágenes');
    });

    // 📊 Reading Progress Bar - SIMPLE Y LIMPIO
    (function() {
        const progressBar = document.getElementById('reading-progress-bar');
        if (!progressBar) return;

        let ticking = false;

        function updateProgressBar() {
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            const scrollableHeight = documentHeight - windowHeight;
            const scrolled = window.pageYOffset || document.documentElement.scrollTop;
            const progress = Math.min(Math.max((scrolled / scrollableHeight) * 100, 0), 100);
            
            progressBar.style.width = `${progress}%`;
            ticking = false;
        }

        function requestTick() {
            if (!ticking) {
                window.requestAnimationFrame(updateProgressBar);
                ticking = true;
            }
        }

        window.addEventListener('scroll', requestTick, { passive: true });
        window.addEventListener('resize', requestTick, { passive: true });
        
        updateProgressBar();
    })();
</script>

<style>
    /* Estilos mínimos para esta fase */
    .bringer-breadcrumb ul {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
        margin: 0 0 1.5rem 0;
        font-size: 0.875rem;
    }
    .bringer-breadcrumb li:not(:last-child)::after {
        content: '/';
        margin-left: 0.5rem;
    }
    .bringer-post-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--bringer-s-border);
    }
    .bringer-post-content {
        font-size: 1.0625rem;
        line-height: 1.9; /* Aumentado de 1.8 a 1.9 */
    }
    
    /* Títulos con espaciado UX/UI optimizado - FORZAR CON !important */
    .bringer-post-body h2 {
        margin-top: 5rem !important;
        margin-bottom: 2rem !important;
        padding-top: 1.5rem !important;
        line-height: 1.3 !important;
    }
    
    .bringer-post-body h3 {
        margin-top: 4rem !important;
        margin-bottom: 1.75rem !important;
        padding-top: 1rem !important;
        line-height: 1.4 !important;
    }
    
    .bringer-post-body h4 {
        margin-top: 3.5rem !important;
        margin-bottom: 1.5rem !important;
        padding-top: 0.75rem !important;
        line-height: 1.4 !important;
    }
    
    /* Espacio extra cuando títulos vienen después de listas o párrafos */
    /* Targeting section context through any wrapper divs */
    .bringer-post-body section ul + h2,
    .bringer-post-body section ol + h2,
    .bringer-post-body section p + h2,
    .bringer-post-body div section ul + h2,
    .bringer-post-body div section ol + h2,
    .bringer-post-body div section p + h2 {
        margin-top: 7rem !important;
        padding-top: 2rem !important;
    }
    
    .bringer-post-body section ul + h3,
    .bringer-post-body section ol + h3,
    .bringer-post-body section p + h3,
    .bringer-post-body div section ul + h3,
    .bringer-post-body div section ol + h3,
    .bringer-post-body div section p + h3 {
        margin-top: 6rem !important;
        padding-top: 1.5rem !important;
    }
    
    /* Títulos después de items de lista individuales */
    .bringer-post-body section li:last-child + h2,
    .bringer-post-body section li:last-child + h3,
    .bringer-post-body div section li:last-child + h2,
    .bringer-post-body div section li:last-child + h3 {
        margin-top: 6.5rem !important;
        padding-top: 2rem !important;
    }
    
    /* H2 y H3 dentro de section (regla general adicional) */
    .bringer-post-body section h2,
    .bringer-post-body div section h2 {
        margin-top: 7rem !important;
        padding-top: 2rem !important;
    }
    
    .bringer-post-body section h3,
    .bringer-post-body div section h3 {
        margin-top: 6rem !important;
        padding-top: 1.5rem !important;
    }
    
    /* Excepción: primer h2 de la section */
    .bringer-post-body section > h2:first-child,
    .bringer-post-body div section > h2:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Efecto de expansión al scroll - UX/UI Premium */
    .st-expandable-wrap {
        overflow: hidden;
        clip-path: inset(0% round 18px);
        border-radius: 18px;
    }
    
    /* 🖼️ Expansión de imágenes - Hero y contenido */
    .bringer-expand-on-scroll,
    .bringer-post-body img {
        transform: scale(1.08);
        transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
    }
    
    .bringer-expand-on-scroll.is-init,
    .bringer-post-body img.is-init {
        transform: scale(1);
    }

    /* Contenedor para imágenes del contenido */
    .bringer-post-body img {
        border-radius: 12px;
        overflow: hidden;
        display: block;
        max-width: 100%;
        height: auto;
    }
    
    .st-expandable-wrap img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
        border-radius: 18px;
    }
    
    /* Fallback para navegadores sin clip-path */
    @supports not (clip-path: inset(0% round 18px)) {
        .st-expandable-wrap {
            border-radius: 18px;
            overflow: hidden;
        }
    }
    /* Excerpt con más espacio */
    .bringer-post-excerpt {
        margin-bottom: 3.5rem; /* Aumentado de 2.5rem */
        padding: 2rem 1.75rem; /* Aumentado padding interno */
        background: rgba(var(--bringer-s-accent-rgb), 0.05);
        border-left: 4px solid var(--bringer-s-accent);
        border-radius: 8px;
    }
    
    .bringer-post-excerpt p {
        line-height: 1.9;
        margin: 0;
    }
    
    /* Párrafos con respiración mejorada */
    .bringer-post-body p {
        margin-bottom: 2rem; /* Aumentado de 1.5rem */
        line-height: 2; /* Aumentado de 1.9 */
        letter-spacing: 0.01em; /* Mejor legibilidad */
    }
    
    /* Listas con espacio generoso */
    .bringer-post-body ul,
    .bringer-post-body ol {
        margin: 2.5rem 0; /* Aumentado de 1.5rem */
        padding-left: 2.5rem; /* Aumentado de 2rem */
    }
    
    .bringer-post-body ul li,
    .bringer-post-body ol li {
        margin-bottom: 1.25rem; /* Aumentado de 0.75rem */
        line-height: 1.9; /* Aumentado de 1.7 */
        padding-left: 0.5rem;
    }
    
    .bringer-post-body ul li:last-child,
    .bringer-post-body ol li:last-child {
        margin-bottom: 0;
    }
    
    /* Listas anidadas */
    .bringer-post-body ul ul,
    .bringer-post-body ol ol,
    .bringer-post-body ul ol,
    .bringer-post-body ol ul {
        margin-top: 1rem;
        margin-bottom: 0;
    }
    
    .bringer-post-body strong {
        color: var(--bringer-s-accent);
        font-weight: 600;
    }
    
    /* Blockquote con más aire */
    .bringer-cta-card {
        margin: 3rem 0; /* Más espacio arriba y abajo */
        padding: 2rem 2.5rem; /* Más padding interno */
    }

    /* 📊 Reading Progress Bar - BOTTOM (inline styles tienen prioridad) */
    #reading-progress-bar {
        /* Todos los estilos están inline para máxima prioridad */
        transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: width;
    }

    /* 🎯 Igualar alturas de cards del carousel */
    .bringer-carousel .swiper-slide {
        height: auto;
        display: flex;
    }

    .bringer-carousel .bringer-blog-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .bringer-carousel .bringer-blog-card a {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .bringer-carousel .bringer-blog-card-footer {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        justify-content: space-between;
    }

    .bringer-carousel .bringer-blog-card-caption {
        flex-grow: 1;
    }

    /* 🎯 Pagination dots - MUY VISIBLES */
    .swiper-pagination.bringer-dots {
        text-align: center !important;
        margin-top: 3rem !important;
        padding: 1.5rem 0 !important;
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet {
        width: 14px !important;
        height: 14px !important;
        background: rgba(255, 255, 255, 0.6) !important;
        opacity: 1 !important;
        transition: all 0.3s ease !important;
        border-radius: 50% !important;
        cursor: pointer !important;
        margin: 0 8px !important;
        border: 2px solid rgba(255, 255, 255, 0.4) !important;
        display: inline-block !important;
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet-active {
        background: var(--accent-color) !important;
        width: 18px !important;
        height: 18px !important;
        box-shadow: 0 0 20px rgba(255, 77, 145, 1) !important;
        border-color: var(--accent-color) !important;
    }

    .swiper-pagination.bringer-dots .swiper-pagination-bullet:hover {
        background: rgba(255, 255, 255, 0.9) !important;
        transform: scale(1.2) !important;
        border-color: rgba(255, 255, 255, 0.7) !important;
    }

    /* SVG en cards del carousel */
    .bringer-blog-card-footer svg {
        transition: transform 0.3s ease;
    }

    .bringer-blog-card:hover .bringer-blog-card-footer svg {
        transform: translateX(5px);
    }
</style>

<script is:inline>
// Forzar espaciado de títulos h2/h3/h4 para evitar que estén pegados
(function() {
    function applySpacing() {
        const postBody = document.querySelector('.bringer-post-body');
        if (!postBody) return;
        
        const h2Elements = postBody.querySelectorAll('section h2');
        const h3Elements = postBody.querySelectorAll('section h3');
        const h4Elements = postBody.querySelectorAll('section h4');
        
        // Aplicar espaciado a h2 (excepto el primero)
        h2Elements.forEach((h2, index) => {
            if (index > 0) {
                h2.style.setProperty('margin-top', '7rem', 'important');
                h2.style.setProperty('padding-top', '2rem', 'important');
            }
        });
        
        // Aplicar espaciado a h3
        h3Elements.forEach((h3) => {
            h3.style.setProperty('margin-top', '6rem', 'important');
            h3.style.setProperty('padding-top', '1.5rem', 'important');
        });
        
        // Aplicar espaciado a h4
        h4Elements.forEach((h4) => {
            h4.style.setProperty('margin-top', '5rem', 'important');
            h4.style.setProperty('padding-top', '1rem', 'important');
        });
        
        // LIMPIAR <p></p> VACÍOS EN LISTAS (causa saltos de línea innecesarios)
        postBody.querySelectorAll('ol, ul').forEach((list) => {
            list.querySelectorAll('p').forEach((p) => {
                // Si el <p> está vacío o solo tiene espacios/saltos
                if (p.innerHTML.trim() === '' || p.textContent.trim() === '') {
                    p.remove();
                }
            });
        });
    }
    
    // Ejecutar al cargar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applySpacing);
    } else {
        applySpacing();
    }
    
    // Re-aplicar por seguridad
    setTimeout(applySpacing, 500);
})();

// Inicializar Carousel de Artículos Relacionados
(function() {
    // Esperar a que Swiper esté disponible
    function initRelatedCarousel() {
        if (typeof Swiper === 'undefined') {
            setTimeout(initRelatedCarousel, 100);
            return;
        }

        const carousel = document.querySelector('.bringer-carousel');
        if (!carousel) return;

        const swiperInstance = new Swiper(carousel, {
            slidesPerView: 1,
            spaceBetween: 30,
            speed: 800,
            grabCursor: true,
            loop: false,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
                pauseOnMouseEnter: true
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
                dynamicBullets: false,
                type: 'bullets'
            },
            on: {
                slideChange: function() {
                    console.log('Slide changed:', this.realIndex);
                }
            },
            breakpoints: {
                // Mobile
                320: {
                    slidesPerView: 1,
                    spaceBetween: 20
                },
                // Tablet
                768: {
                    slidesPerView: 2,
                    spaceBetween: 30
                },
                // Desktop
                1024: {
                    slidesPerView: 3,
                    spaceBetween: 30
                }
            }
        });
    }

    // Iniciar cuando DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRelatedCarousel);
    } else {
        initRelatedCarousel();
    }
})();
</script>
